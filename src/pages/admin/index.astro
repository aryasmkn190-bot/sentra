---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { db } from '../../lib/db';
import { orders, products } from '../../lib/schema';
import { eq, desc, sql, count } from 'drizzle-orm';
import { getAdminUser, getAllowedOffices } from '../../lib/auth';

const adminUser = getAdminUser(Astro.request);
const allowedOffices = getAllowedOffices(Astro.request);
const isSuperAdmin = adminUser?.role === 'super_admin';

let stats = {
  totalOrders: 0,
  todayOrders: 0,
  totalProducts: 0,
  totalRevenue: 0,
  pendingRevenue: 0,
  confirmedRevenue: 0,
};

let recentOrders: any[] = [];
let itemBreakdown: Record<string, { name: string; type: string; quantity: number; revenue: number }> = {};
let pendingOrders: any[] = [];

let officeList: string[] = [];
let clientOrdersJson = "[]";

try {
  let allOrders = await db.select().from(orders).orderBy(desc(orders.createdAt));
  const allProducts = await db.select().from(products);
  
  // Filter orders by allowed offices for regular admins
  if (allowedOffices !== null) {
    allOrders = allOrders.filter(o => allowedOffices.includes(o.kelompok));
  }

  // Define unique office list
  officeList = [...new Set(allOrders.map(o => o.kelompok))].sort();
  
  // Minimal json for client JS filtering
  const minimalOrders = allOrders.map(o => ({
    id: o.id,
    orderNumber: o.orderNumber,
    customerName: o.customerName,
    whatsappNumber: o.whatsappNumber,
    kelompok: o.kelompok,
    status: o.status,
    totalAmount: o.totalAmount || 0,
    items: o.items || [],
    createdAt: o.createdAt
  }));
  clientOrdersJson = JSON.stringify(minimalOrders);
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  stats.totalOrders = allOrders.length;
  stats.todayOrders = allOrders.filter(o => new Date(o.createdAt) >= today).length;
  stats.totalProducts = allProducts.length;
  stats.pendingRevenue = allOrders
    .filter(o => o.status === 'pending')
    .reduce((sum, o) => sum + (o.totalAmount || 0), 0);
  stats.confirmedRevenue = allOrders
    .filter(o => o.status === 'confirmed')
    .reduce((sum, o) => sum + (o.totalAmount || 0), 0);
  stats.totalRevenue = stats.pendingRevenue + stats.confirmedRevenue;
  
  recentOrders = allOrders.slice(0, 10);

  // Pending orders for follow-up
  pendingOrders = allOrders.filter(o => o.status === 'pending');

  // Build per-item breakdown from CONFIRMED orders only (for product preparation)
  const confirmedOrders = allOrders.filter(o => o.status === 'confirmed');
  for (const order of confirmedOrders) {
    const items = (order.items as any[]) || [];
    for (const item of items) {
      const key = item.productName || 'Unknown';
      const type = item.productType || 'satuan';
      if (!itemBreakdown[key]) {
        itemBreakdown[key] = { name: key, type, quantity: 0, revenue: 0 };
      }
      itemBreakdown[key].quantity += item.quantity || 0;
      itemBreakdown[key].revenue += (item.quantity || 0) * (item.price || 0);
    }
  }
} catch (error) {
  console.error('Dashboard error:', error);
}

// Sort items: by quantity descending
const satuanItems = Object.values(itemBreakdown)
  .filter(i => i.type === 'satuan')
  .sort((a, b) => b.quantity - a.quantity);

const paketItems = Object.values(itemBreakdown)
  .filter(i => i.type === 'paket')
  .sort((a, b) => b.quantity - a.quantity);

const totalSatuanQty = satuanItems.reduce((s, i) => s + i.quantity, 0);
const totalPaketQty = paketItems.reduce((s, i) => s + i.quantity, 0);

const statusColors: Record<string, string> = {
  pending: 'warning',
  confirmed: 'info',
  processing: 'info',
  completed: 'success',
  cancelled: 'danger',
};

const statusLabels: Record<string, string> = {
  pending: 'Menunggu',
  confirmed: 'Dikonfirmasi',
  processing: 'Diproses',
  completed: 'Selesai',
  cancelled: 'Dibatalkan',
};
---

<AdminLayout title="Dashboard" activeMenu="dashboard">
  
  <!-- Global Dashboard Header & Filter -->
  <div class="dashboard-top-bar">
    <div class="dt-bar-left"></div>
    {isSuperAdmin && officeList.length > 1 && (
      <div class="global-filter-wrap">
        <span class="filter-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </span>
        <select id="globalOfficeFilter" class="modern-filter-select">
          <option value="all">üè¢ Semua Kantor (Global)</option>
          {officeList.map(o => (
            <option value={o}>{o}</option>
          ))}
        </select>
      </div>
    )}
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #3B82F6, #60A5FA);">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
      </div>
      <div class="stat-info">
        <span class="stat-value" id="stat-total-orders">{stats.totalOrders}</span>
        <span class="stat-label">Total Pesanan</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #F59E0B, #FBBF24);">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <div class="stat-info">
        <span class="stat-value" id="stat-today-orders">{stats.todayOrders}</span>
        <span class="stat-label">Hari Ini</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #22C55E, #4ADE80);">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
      </div>
      <div class="stat-info">
        <span class="stat-value" id="stat-total-products">{stats.totalProducts}</span>
        <span class="stat-label">Produk Aktif</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #F59E0B, #FCD34D);">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      </div>
      <div class="stat-info">
        <span class="stat-value stat-value-sm" id="stat-pending-rev">Rp {stats.pendingRevenue.toLocaleString('id-ID')}</span>
        <span class="stat-label">‚è≥ Menunggu</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #10B981, #34D399);">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      </div>
      <div class="stat-info">
        <span class="stat-value stat-value-sm" id="stat-confirmed-rev">Rp {stats.confirmedRevenue.toLocaleString('id-ID')}</span>
        <span class="stat-label">‚úÖ Dikonfirmasi</span>
      </div>
    </div>
    <div class="stat-card stat-card-total">
      <div class="stat-icon" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      </div>
      <div class="stat-info">
        <span class="stat-value stat-value-sm" id="stat-total-rev">Rp {stats.totalRevenue.toLocaleString('id-ID')}</span>
        <span class="stat-label">üí∞ Total Pendapatan</span>
      </div>
    </div>
  </div>

  <!-- Quick Actions (Mobile) -->
  <div class="quick-actions">
    <a href="/admin/orders" class="quick-action-btn">
      <span>üìã</span> Lihat Pesanan
    </a>
    {isSuperAdmin && (
      <a href="/admin/products" class="quick-action-btn">
        <span>‚ûï</span> Tambah Produk
      </a>
    )}
  </div>

  <!-- Item Breakdown: Confirmed Orders Only (for preparation) -->
  {(satuanItems.length > 0 || paketItems.length > 0) && (
    <div class="dashboard-section item-breakdown-section">
      <div class="section-header-row">
        <h2>üìã Rekap Item Dikonfirmasi</h2>
        <span class="section-badge section-badge-confirmed">‚úÖ {totalSatuanQty + totalPaketQty} item ini perlu disiapkan</span>
      </div>
      <p class="section-desc">Daftar item dari pesanan yang sudah <strong>dikonfirmasi</strong> ‚Äî siapkan produk berikut:</p>

      <!-- Satuan Items -->
      {satuanItems.length > 0 && (
        <div class="breakdown-group">
          <div class="breakdown-group-header">
            <span class="breakdown-group-icon">üö¨</span>
            <span class="breakdown-group-title">Produk Satuan</span>
            <span class="breakdown-group-total">{totalSatuanQty} pcs</span>
          </div>
          <div class="item-breakdown-grid">
            {satuanItems.map((item, idx) => {
              const maxQty = satuanItems[0]?.quantity || 1;
              const pct = Math.round((item.quantity / maxQty) * 100);
              return (
                <div class="item-row" style={`animation-delay: ${idx * 0.04}s`}>
                  <div class="item-row-main">
                    <span class="item-rank">#{idx + 1}</span>
                    <div class="item-name-col">
                      <span class="item-name">{item.name}</span>
                      <span class="item-revenue">Rp {item.revenue.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="item-qty-badge">
                      <strong>{item.quantity}</strong>
                      <small>pcs</small>
                    </div>
                  </div>
                  <div class="item-bar-track">
                    <div class="item-bar-fill" style={`width: ${pct}%`}></div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      <!-- Paket Items -->
      {paketItems.length > 0 && (
        <div class="breakdown-group breakdown-group-paket">
          <div class="breakdown-group-header">
            <span class="breakdown-group-icon">üì¶</span>
            <span class="breakdown-group-title">Produk Paket</span>
            <span class="breakdown-group-total">{totalPaketQty} pcs</span>
          </div>
          <div class="paket-breakdown-grid">
            {paketItems.map((item) => (
              <div class="paket-item-card">
                <div class="paket-item-name">{item.name}</div>
                <div class="paket-item-stats">
                  <span class="paket-item-qty">{item.quantity} pcs</span>
                  <span class="paket-item-rev">Rp {item.revenue.toLocaleString('id-ID')}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )}

  <!-- Pending Orders for Follow-Up -->
  <div class="dashboard-section pending-section">
    <div class="section-header-row">
      <h2>‚è≥ Pesanan Menunggu Follow Up</h2>
      <span class="section-badge section-badge-pending">{pendingOrders.length} pesanan</span>
    </div>
    {pendingOrders.length > 0 ? (
      <>
        <p class="section-desc">Pesanan berikut masih berstatus <strong>menunggu</strong> ‚Äî hubungi pelanggan untuk konfirmasi pembayaran.</p>
        <div class="followup-tip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          <span>üí° <strong>Tips:</strong> Disarankan mengirim follow up <strong>maksimal 1 kali per hari</strong> untuk setiap pelanggan agar tidak mengganggu.</span>
        </div>

        {/* Desktop Table */}
      <div class="table-wrapper desktop-table modern-table-card">
        <table class="table modern-table" id="pendingTable">
          <thead>
            <tr>
              <th>Pelanggan</th>
              <th>WhatsApp</th>
              <th>Kantor</th>
              <th>Item Pesanan</th>
              <th>Total Biaya</th>
              <th>Waktu Order</th>
              <th class="text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="pendingContainer">
              {pendingOrders.map((order) => (
                <tr class="modern-tr">
                  <td>
                    <strong>{order.customerName}</strong>
                    <br/><small class="text-muted"><code>{order.orderNumber}</code></small>
                  </td>
                  <td>
                    <span class="wa-number">{order.whatsappNumber}</span>
                  </td>
                  <td><span class="badge badge-neutral">{order.kelompok}</span></td>
                  <td>
                    <div class="items-mini">
                      {(order.items as any[] || []).map((item: any) => (
                        <small>‚Ä¢ {item.productName} √ó{item.quantity}</small>
                      ))}
                    </div>
                  </td>
                  <td class="text-accent"><strong>Rp {(order.totalAmount || 0).toLocaleString('id-ID')}</strong></td>
                  <td class="text-muted" style="white-space:nowrap;">
                    {new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}
                  </td>
                  <td class="text-right">
                    <button class="wa-followup-btn" data-order-id={order.id} data-customer-name={order.customerName}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                      <span class="followup-btn-text">Follow Up</span>
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          <!-- Desktop Pagination -->
          <div class="pagination-footer" id="pendingPagination" style={pendingOrders.length > 5 ? '' : 'display: none;'}>
            <button class="btn btn-outline btn-sm" id="pendingPrev" disabled>Sebelumnya</button>
            <span class="page-info" id="pendingPageInfo">Halaman 1</span>
            <button class="btn btn-outline btn-sm" id="pendingNext">Selanjutnya</button>
          </div>
        </div>

        {/* Mobile Cards */}
        <div id="pendingMobileContainer" class="mobile-orders-list">
           {pendingOrders.slice(0, 5).map((order) => (
            <div class="pending-card">
              <div class="pending-card-body">
                <div class="pending-card-header">
                  <div class="pending-card-customer">
                    <strong>{order.customerName}</strong>
                    <span class="text-muted">{order.whatsappNumber}</span>
                  </div>
                  <span class="badge badge-warning">Menunggu</span>
                </div>
                <div class="pending-card-items">
                  {(order.items as any[] || []).map((item: any) => (
                    <small>‚Ä¢ {item.productName} √ó{item.quantity}</small>
                  ))}
                </div>
                <div class="pending-card-footer">
                  <div class="pending-card-meta">
                    <code>{order.orderNumber}</code>
                    <span class="badge badge-neutral">{order.kelompok}</span>
                    <small class="text-muted">{new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</small>
                  </div>
                  <div class="pending-card-action">
                    <span class="pending-card-total">Rp {(order.totalAmount || 0).toLocaleString('id-ID')}</span>
                    <button class="wa-followup-btn-mobile" data-order-id={order.id} data-customer-name={order.customerName}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                      <span class="followup-btn-text">Follow Up</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
        <!-- Mobile Pagination -->
        <div class="pagination-footer pagination-mobile-only" id="pendingMobilePagination" style={pendingOrders.length > 5 ? '' : 'display: none;'}>
          <button class="btn btn-outline btn-sm" id="pendingMobilePrev" disabled>Sebelumnya</button>
          <span class="page-info" id="pendingMobilePageInfo">Halaman 1</span>
          <button class="btn btn-outline btn-sm" id="pendingMobileNext">Selanjutnya</button>
        </div>
      </>
    ) : (
      <div class="empty-state-card pending-empty">
        <div class="empty-icon">üéâ</div>
        <p>Semua pesanan sudah ditindaklanjuti!</p>
        <small>Tidak ada pesanan menunggu saat ini</small>
      </div>
    )}
  </div>

  <!-- Follow Up Success Modal -->
  <div class="followup-overlay" id="followupOverlay">
    <div class="followup-modal">
      <div class="followup-checkmark-wrap">
        <svg class="followup-checkmark" viewBox="0 0 52 52">
          <circle class="followup-checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="followup-checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      </div>
      <h3 id="followupModalTitle">Pesan Terkirim!</h3>
      <p id="followupModalDesc">Pesan follow up berhasil dikirim ke <strong id="followupCustomerName"></strong> melalui WhatsApp.</p>
      <div class="followup-modal-tip">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Hindari mengirim follow up lebih dari 1 kali dalam sehari agar pelanggan tidak terganggu.</span>
      </div>
      <button class="followup-modal-close-btn" id="followupModalClose">Mengerti</button>
    </div>
  </div>

  <!-- Recent Orders -->
  <div class="dashboard-section recent-section">
    <div class="modern-section-card">
      <div class="msc-header">
        <div class="msc-title-wrap">
          <div class="msc-icon" style="background: linear-gradient(135deg, #6366F1, #8B5CF6);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
          </div>
          <div>
            <h2 class="msc-title">Pesanan Terbaru</h2>
            <p class="msc-subtitle">Semua pesanan masuk terbaru</p>
          </div>
        </div>
        <a href="/admin/orders" class="msc-action-link">Lihat Semua <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m9 18 6-6-6-6"/></svg></a>
      </div>
    
    <div id="recentContentWrapper">
      {/* Desktop Table */}
      <div class="table-wrapper desktop-table modern-table-card">
        <table class="table modern-table" id="recentTable">
          <thead>
            <tr>
              <th>No. Order</th>
              <th>Pelanggan</th>
              <th>Kantor</th>
              <th>Total Biaya</th>
              <th>Status</th>
              <th>Waktu</th>
            </tr>
          </thead>
          <tbody id="recentContainer">
            {recentOrders.slice(0, 5).map((order) => (
              <tr class="modern-tr">
                <td><code>{order.orderNumber}</code></td>
                <td>
                  <strong>{order.customerName}</strong>
                  <br/><small class="text-muted">{order.whatsappNumber}</small>
                </td>
                <td><span class="badge badge-neutral">{order.kelompok}</span></td>
                <td class="text-accent"><strong>Rp {(order.totalAmount || 0).toLocaleString('id-ID')}</strong></td>
                <td>
                  <span class={`badge badge-${statusColors[order.status] || 'neutral'}`}>
                    {statusLabels[order.status] || order.status}
                  </span>
                </td>
                <td class="text-muted">{new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</td>
              </tr>
            ))}
          </tbody>
        </table>
        <!-- Desktop Pagination -->
        <div class="pagination-footer" id="recentPagination" style={recentOrders.length > 5 ? '' : 'display: none;'}>
          <button class="btn btn-outline btn-sm" id="recentPrev" disabled>Sebelumnya</button>
          <span class="page-info" id="recentPageInfo">Halaman 1</span>
          <button class="btn btn-outline btn-sm" id="recentNext">Selanjutnya</button>
        </div>
      </div>

      {/* Mobile Cards */}
      <div id="recentMobileContainer" class="mobile-orders-list">
        {recentOrders.slice(0, 5).map((order) => {
          const sColor = statusColors[order.status] || 'neutral';
          const sLabel = statusLabels[order.status] || order.status;
          const gradientMap = {
            warning: 'linear-gradient(180deg, #F59E0B, #D97706)',
            info: 'linear-gradient(180deg, #3B82F6, #2563EB)',
            success: 'linear-gradient(180deg, #22C55E, #16A34A)',
            danger: 'linear-gradient(180deg, #EF4444, #DC2626)',
            neutral: 'linear-gradient(180deg, #94A3B8, #64748B)',
          };
          return (
          <div class="moc-card">
            <div class="moc-accent-bar" style={`background: ${gradientMap[sColor] || gradientMap.neutral};`}></div>
            <div class="moc-card-body">
              <div class="moc-row-top">
                <div class="moc-customer">
                  <span class="moc-customer-name">{order.customerName}</span>
                  <span class="moc-customer-phone">{order.whatsappNumber}</span>
                </div>
                <span class={`badge badge-${sColor}`}>{sLabel}</span>
              </div>
              <div class="moc-divider"></div>
              <div class="moc-row-bottom">
                <div class="moc-order-meta">
                  <code class="moc-order-code">{order.orderNumber}</code>
                  <span class="badge badge-neutral moc-office">{order.kelompok}</span>
                </div>
                <div class="moc-amount-wrap">
                  <span class="moc-amount">Rp {(order.totalAmount || 0).toLocaleString('id-ID')}</span>
                  <span class="moc-date">{new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                </div>
              </div>
            </div>
          </div>
        )})}
      </div>
      <!-- Mobile Pagination -->
      <div class="pagination-footer pagination-mobile-only" id="recentMobilePagination" style={recentOrders.length > 5 ? '' : 'display: none;'}>
        <button class="btn btn-outline btn-sm" id="recentMobilePrev" disabled>Sebelumnya</button>
        <span class="page-info" id="recentMobilePageInfo">Halaman 1</span>
        <button class="btn btn-outline btn-sm" id="recentMobileNext">Selanjutnya</button>
      </div>
    </div>
    </div>
    
    <div id="recentEmptyState" class="empty-state-card" style={recentOrders.length === 0 ? '' : 'display: none;'}>
      <div class="empty-icon">üì¶</div>
      <p>Belum ada pesanan masuk</p>
      <small>Pesanan dari pelanggan akan muncul di sini</small>
    </div>
  </div>
</AdminLayout>

<script>
  // ===== FOLLOW UP VIA API (DELEGATED) =====
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.wa-followup-btn, .wa-followup-btn-mobile');
    if (!btn) return;
    
    // Check if it's disabled
    if (btn.disabled) return;

    const orderId = btn.dataset.orderId || '';
    const customerName = btn.dataset.customerName || '';
    const textEl = btn.querySelector('.followup-btn-text');

    // Loading state
    btn.disabled = true;
    btn.classList.add('sending');
    if (textEl) textEl.textContent = 'Mengirim...';

    try {
      const res = await fetch('/api/followup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId: parseInt(orderId) }),
      });
      const result = await res.json();

      if (result.success) {
        showFollowupSuccess(result.customerName || customerName);
        btn.classList.remove('sending');
        btn.classList.add('sent');
        if (textEl) textEl.textContent = 'Terkirim ‚úì';
      } else {
        btn.classList.remove('sending');
        btn.disabled = false;
        if (textEl) textEl.textContent = 'Follow Up';
        window.showToast?.(result.message || 'Gagal mengirim pesan', 'error');
      }
    } catch {
      btn.classList.remove('sending');
      btn.disabled = false;
      if (textEl) textEl.textContent = 'Follow Up';
      window.showToast?.('Terjadi kesalahan jaringan', 'error');
    }
  });

  // Success modal
  function showFollowupSuccess(name) {
    const overlay = document.getElementById('followupOverlay');
    const nameEl = document.getElementById('followupCustomerName');
    if (nameEl) nameEl.textContent = name;
    overlay?.classList.add('open');
  }

  function hideFollowupModal() {
    document.getElementById('followupOverlay')?.classList.remove('open');
  }

  document.getElementById('followupModalClose')?.addEventListener('click', hideFollowupModal);
  document.getElementById('followupOverlay')?.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) hideFollowupModal();
  });
</script>

<script define:vars={{ clientOrdersJson }}>
  const allOrders = JSON.parse(clientOrdersJson || "[]");
  let currentOffice = 'all';

  let breakdownPage = 1;
  const breakdownLimit = 5;

  let pendingPage = 1;
  const pendingLimit = 5;

  let recentPage = 1;
  const recentLimit = 5;

  const statusColors = {
    pending: 'warning',
    confirmed: 'info',
    processing: 'info',
    completed: 'success',
    cancelled: 'danger',
  };

  const statusLabels = {
    pending: 'Menunggu',
    confirmed: 'Dikonfirmasi',
    processing: 'Diproses',
    completed: 'Selesai',
    cancelled: 'Dibatalkan',
  };

  function renderDashboard() {
    const filteredOrders = currentOffice === 'all' 
      ? allOrders 
      : allOrders.filter(o => o.kelompok === currentOffice);

    // 1. STATS
    const today = new Date();
    today.setHours(0,0,0,0);
    const todayCount = filteredOrders.filter(o => new Date(o.createdAt) >= today).length;
    const pendingRev = filteredOrders.filter(o => o.status === 'pending').reduce((s, o) => s + o.totalAmount, 0);
    const confirmedRev = filteredOrders.filter(o => o.status === 'confirmed').reduce((s, o) => s + o.totalAmount, 0);
    const totalRev = pendingRev + confirmedRev;

    const elTotalOrd = document.getElementById('stat-total-orders');
    if (elTotalOrd) elTotalOrd.textContent = filteredOrders.length;
    
    const elTodayOrd = document.getElementById('stat-today-orders');
    if (elTodayOrd) elTodayOrd.textContent = todayCount;
    
    // total-products stays global (not filtered by office)
    
    const elPendingRev = document.getElementById('stat-pending-rev');
    if (elPendingRev) elPendingRev.textContent = `Rp ${pendingRev.toLocaleString('id-ID')}`;
    
    const elConfirmedRev = document.getElementById('stat-confirmed-rev');
    if (elConfirmedRev) elConfirmedRev.textContent = `Rp ${confirmedRev.toLocaleString('id-ID')}`;

    const elTotalRev = document.getElementById('stat-total-rev');
    if (elTotalRev) elTotalRev.textContent = `Rp ${totalRev.toLocaleString('id-ID')}`;

    // 2. BREAKDOWN ITEMS
    const confirmedOrders = filteredOrders.filter(o => o.status === 'confirmed');
    const itemMap = {};
    for (const order of confirmedOrders) {
      if (!order.items) continue;
      for (const item of order.items) {
        const key = item.productName || 'Unknown';
        if (!itemMap[key]) itemMap[key] = { name: key, type: item.productType || 'satuan', quantity: 0, revenue: 0 };
        itemMap[key].quantity += (item.quantity || 0);
        itemMap[key].revenue += ((item.quantity || 0) * (item.price || 0));
      }
    }
    const breakdownArr = Object.values(itemMap).sort((a, b) => b.quantity - a.quantity);
    const totalBreakdownQty = breakdownArr.reduce((s, i) => s + i.quantity, 0);

    const breakdownBadge = document.getElementById('breakdownBadge');
    if (breakdownBadge) breakdownBadge.textContent = `‚úÖ ${totalBreakdownQty} item disiapkan`;

    const breakdownWrapper = document.getElementById('breakdownSectionWrapper');
    if (breakdownWrapper) breakdownWrapper.style.display = breakdownArr.length > 0 ? '' : 'none';

    // Pagination slice
    const maxIdx = Math.ceil(breakdownArr.length / breakdownLimit);
    if (breakdownPage > maxIdx && maxIdx > 0) breakdownPage = maxIdx;
    
    const sliceStart = (breakdownPage - 1) * breakdownLimit;
    const paginatedBreakdown = breakdownArr.slice(sliceStart, sliceStart + breakdownLimit);

    const breakdownContainer = document.getElementById('breakdownContainer');
    if (breakdownContainer) {
      if (paginatedBreakdown.length === 0) {
        breakdownContainer.innerHTML = `<tr class="modern-empty-tr"><td colspan="5">üì≠ Tidak ada item dikonfirmasi.</td></tr>`;
      } else {
        breakdownContainer.innerHTML = paginatedBreakdown.map((item, idx) => {
          const rank = sliceStart + idx + 1;
          const isPaket = item.type === 'paket';
          return `<tr class="modern-tr" style="animation-delay: ${idx * 0.03}s">
            <td><span class="modern-rank">#${rank}</span></td>
            <td><strong>${item.name}</strong></td>
            <td><span class="badge ${isPaket ? 'badge-primary' : 'badge-neutral'}">${isPaket ? 'üì¶ Paket' : 'üö¨ Satuan'}</span></td>
            <td class="text-right"><span class="qty-highlight">${item.quantity}</span> <small class="text-muted">pcs</small></td>
            <td class="text-right text-accent" style="font-family: var(--font-heading);"><strong>Rp ${item.revenue.toLocaleString('id-ID')}</strong></td>
          </tr>`;
        }).join('');
      }
    }

    const breakdownPagination = document.getElementById('breakdownPagination');
    if (breakdownPagination) {
      breakdownPagination.style.display = breakdownArr.length > breakdownLimit ? 'flex' : 'none';
      const prevBtn = document.getElementById('breakdownPrev');
      if (prevBtn) prevBtn.disabled = breakdownPage === 1;
      const nextBtn = document.getElementById('breakdownNext');
      if (nextBtn) nextBtn.disabled = breakdownPage >= maxIdx;
      const info = document.getElementById('breakdownPageInfo');
      if (info) info.textContent = `Halaman ${breakdownPage} dari ${maxIdx}`;
    }

    // 3. PENDING ORDERS
    const pendings = filteredOrders.filter(o => o.status === 'pending');
    const pb = document.getElementById('pendingBadge');
    if (pb) pb.textContent = `${pendings.length} pesanan`;

    const pw = document.getElementById('pendingContentWrapper');
    if (pw) pw.style.display = pendings.length > 0 ? '' : 'none';
    const pe = document.getElementById('pendingEmptyState');
    if (pe) pe.style.display = pendings.length === 0 ? '' : 'none';

    const pMaxIdx = Math.ceil(pendings.length / pendingLimit);
    if (pendingPage > pMaxIdx && pMaxIdx > 0) pendingPage = pMaxIdx;

    const pSliceStart = (pendingPage - 1) * pendingLimit;
    const pPaginated = pendings.slice(pSliceStart, pSliceStart + pendingLimit);

    const pc = document.getElementById('pendingContainer');
    if (pc) {
      pc.innerHTML = pPaginated.map((order) => {
        const itemHtml = (order.items || []).map(i => `<small>‚Ä¢ ${i.productName} √ó${i.quantity}</small>`).join('');
        const dateStr = new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        const followupSvg = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>`;
        return `<tr>
          <td><strong>${order.customerName}</strong><br/><small class="text-muted"><code>${order.orderNumber}</code></small></td>
          <td><span class="wa-number">${order.whatsappNumber}</span></td>
          <td><span class="badge badge-neutral">${order.kelompok}</span></td>
          <td><div class="items-mini">${itemHtml}</div></td>
          <td class="text-accent"><strong>Rp ${order.totalAmount.toLocaleString('id-ID')}</strong></td>
          <td class="text-muted" style="white-space:nowrap;">${dateStr}</td>
          <td>
            <button class="wa-followup-btn" data-order-id="${order.id}" data-customer-name="${order.customerName}">
              ${followupSvg}
              <span class="followup-btn-text">Follow Up</span>
            </button>
          </td>
        </tr>`;
      }).join('');
    }

    const pmc = document.getElementById('pendingMobileContainer');
    if (pmc) {
      pmc.innerHTML = pPaginated.map((order) => {
        const itemHtml = (order.items || []).map(i => `<small>‚Ä¢ ${i.productName} √ó${i.quantity}</small>`).join('');
        const dateStr = new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        const followupSvg = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>`;
        return `<div class="pending-card">
          <div class="pending-card-body">
            <div class="pending-card-header">
              <div class="pending-card-customer"><strong>${order.customerName}</strong><span class="text-muted">${order.whatsappNumber}</span></div>
              <span class="badge badge-warning">Menunggu</span>
            </div>
            <div class="pending-card-items">${itemHtml}</div>
            <div class="pending-card-footer">
              <div class="pending-card-meta"><code>${order.orderNumber}</code><span class="badge badge-neutral">${order.kelompok}</span><small class="text-muted">${dateStr}</small></div>
              <div class="pending-card-action">
                <span class="pending-card-total">Rp ${order.totalAmount.toLocaleString('id-ID')}</span>
                <button class="wa-followup-btn-mobile" data-order-id="${order.id}" data-customer-name="${order.customerName}">
                  ${followupSvg}<span class="followup-btn-text">Follow Up</span>
                </button>
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    const pp = document.getElementById('pendingPagination');
    if (pp) {
      pp.style.display = pendings.length > pendingLimit ? 'flex' : 'none';
      if (pendings.length > pendingLimit) {
        document.getElementById('pendingPrev').disabled = pendingPage === 1;
        document.getElementById('pendingNext').disabled = pendingPage >= pMaxIdx;
        document.getElementById('pendingPageInfo').textContent = `Halaman ${pendingPage} dari ${pMaxIdx}`;
      }
    }
    const pmp = document.getElementById('pendingMobilePagination');
    if (pmp) {
      pmp.style.display = pendings.length > pendingLimit ? 'flex' : 'none';
      if (pendings.length > pendingLimit) {
        document.getElementById('pendingMobilePrev').disabled = pendingPage === 1;
        document.getElementById('pendingMobileNext').disabled = pendingPage >= pMaxIdx;
        document.getElementById('pendingMobilePageInfo').textContent = `Halaman ${pendingPage} dari ${pMaxIdx}`;
      }
    }

    // 4. RECENT ORDERS
    const rMaxIdx = Math.ceil(filteredOrders.length / recentLimit);
    if (recentPage > rMaxIdx && rMaxIdx > 0) recentPage = rMaxIdx;

    const rSliceStart = (recentPage - 1) * recentLimit;
    const rPaginated = filteredOrders.slice(rSliceStart, rSliceStart + recentLimit);

    const rw = document.getElementById('recentContentWrapper');
    if (rw) rw.style.display = filteredOrders.length > 0 ? '' : 'none';
    const re = document.getElementById('recentEmptyState');
    if (re) re.style.display = filteredOrders.length === 0 ? '' : 'none';

    const rc = document.getElementById('recentContainer');
    if (rc) {
      rc.innerHTML = rPaginated.map((order) => {
        const dateStr = new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        const cColor = statusColors[order.status] || 'neutral';
        const cLabel = statusLabels[order.status] || order.status;
        return `<tr class="modern-tr">
          <td><code>${order.orderNumber}</code></td>
          <td><strong>${order.customerName}</strong><br/><small class="text-muted">${order.whatsappNumber}</small></td>
          <td><span class="badge badge-neutral">${order.kelompok}</span></td>
          <td class="text-accent"><strong>Rp ${order.totalAmount.toLocaleString('id-ID')}</strong></td>
          <td><span class="badge badge-${cColor}">${cLabel}</span></td>
          <td class="text-muted" style="white-space:nowrap;">${dateStr}</td>
        </tr>`;
      }).join('');
    }

    const rmc = document.getElementById('recentMobileContainer');
    if (rmc) {
      const gradientMap = {
        warning: 'linear-gradient(180deg, #F59E0B, #D97706)',
        info: 'linear-gradient(180deg, #3B82F6, #2563EB)',
        success: 'linear-gradient(180deg, #22C55E, #16A34A)',
        danger: 'linear-gradient(180deg, #EF4444, #DC2626)',
        neutral: 'linear-gradient(180deg, #94A3B8, #64748B)',
      };
      rmc.innerHTML = rPaginated.map((order) => {
        const dateStr = new Date(order.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        const cColor = statusColors[order.status] || 'neutral';
        const cLabel = statusLabels[order.status] || order.status;
        const grad = gradientMap[cColor] || gradientMap.neutral;
        return `<div class="moc-card">
          <div class="moc-accent-bar" style="background: ${grad};"></div>
          <div class="moc-card-body">
            <div class="moc-row-top">
              <div class="moc-customer">
                <span class="moc-customer-name">${order.customerName}</span>
                <span class="moc-customer-phone">${order.whatsappNumber}</span>
              </div>
              <span class="badge badge-${cColor}">${cLabel}</span>
            </div>
            <div class="moc-divider"></div>
            <div class="moc-row-bottom">
              <div class="moc-order-meta">
                <code class="moc-order-code">${order.orderNumber}</code>
                <span class="badge badge-neutral moc-office">${order.kelompok}</span>
              </div>
              <div class="moc-amount-wrap">
                <span class="moc-amount">Rp ${order.totalAmount.toLocaleString('id-ID')}</span>
                <span class="moc-date">${dateStr}</span>
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    // Pagination Controls
    const rp = document.getElementById('recentPagination');
    if (rp) {
      rp.style.display = filteredOrders.length > recentLimit ? 'flex' : 'none';
      if (filteredOrders.length > recentLimit) {
        document.getElementById('recentPrev').disabled = recentPage === 1;
        document.getElementById('recentNext').disabled = recentPage >= rMaxIdx;
        document.getElementById('recentPageInfo').textContent = `Halaman ${recentPage} dari ${rMaxIdx}`;
      }
    }
    const rmp = document.getElementById('recentMobilePagination');
    if (rmp) {
      rmp.style.display = filteredOrders.length > recentLimit ? 'flex' : 'none';
      if (filteredOrders.length > recentLimit) {
        document.getElementById('recentMobilePrev').disabled = recentPage === 1;
        document.getElementById('recentMobileNext').disabled = recentPage >= rMaxIdx;
        document.getElementById('recentMobilePageInfo').textContent = `Halaman ${recentPage} dari ${rMaxIdx}`;
      }
    }
  }

  // GLOBAL FILTER BINDING
  document.getElementById('globalOfficeFilter')?.addEventListener('change', (e) => {
    currentOffice = e.target.value;
    breakdownPage = 1;
    pendingPage = 1;
    renderDashboard();
  });

  // PAGINATION BINDINGS
  document.addEventListener('click', (e) => {
    const t = e.target;
    if (t.id === 'breakdownPrev') { breakdownPage--; renderDashboard(); }
    if (t.id === 'breakdownNext') { breakdownPage++; renderDashboard(); }
    if (t.id === 'pendingPrev' || t.id === 'pendingMobilePrev') { pendingPage--; renderDashboard(); }
    if (t.id === 'pendingNext' || t.id === 'pendingMobileNext') { pendingPage++; renderDashboard(); }
    if (t.id === 'recentPrev' || t.id === 'recentMobilePrev') { recentPage--; renderDashboard(); }
    if (t.id === 'recentNext' || t.id === 'recentMobileNext') { recentPage++; renderDashboard(); }
  });

  // INITIALIZE
  renderDashboard();
</script>

<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 20px;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-card);
    transition: all 0.25s ease;
    animation: fadeIn 0.4s ease forwards;
  }

  .stat-card:nth-child(1) { animation-delay: 0.05s; }
  .stat-card:nth-child(2) { animation-delay: 0.1s; }
  .stat-card:nth-child(3) { animation-delay: 0.15s; }
  .stat-card:nth-child(4) { animation-delay: 0.2s; }
  .stat-card:nth-child(5) { animation-delay: 0.25s; }
  .stat-card:nth-child(6) { animation-delay: 0.3s; }

  .stat-card-total {
    border: 1.5px solid rgba(139, 92, 246, 0.25);
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.03), rgba(167, 139, 250, 0.06));
  }

  .stat-card:hover {
    box-shadow: var(--shadow-card-hover);
    transform: translateY(-2px);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-lg);
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
  }

  .stat-info { display: flex; flex-direction: column; min-width: 0; }

  .stat-value {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--color-text-primary);
    line-height: 1.2;
  }

  .stat-value-sm { font-size: 1.1rem; }

  .stat-label {
    font-size: 0.78rem;
    color: var(--color-text-muted);
    margin-top: 2px;
    white-space: nowrap;
  }

  .quick-actions {
    display: none;
    gap: 10px;
    margin-bottom: 20px;
  }

  .quick-action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--color-text-primary);
    text-decoration: none;
    transition: all 0.15s;
    box-shadow: var(--shadow-xs);
  }

  .quick-action-btn:hover { border-color: var(--color-accent); color: var(--color-accent); }

  .dashboard-section {
    animation: fadeIn 0.4s ease 0.25s forwards;
    opacity: 0;
  }

  .section-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-header-row h2 { font-size: 1.1rem; }

  code {
    font-size: 0.78rem;
    background: var(--color-bg-tertiary);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-family: 'SF Mono', Monaco, monospace;
  }

  .empty-state-card {
    text-align: center;
    padding: 48px 24px;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-card);
  }
  .empty-icon { font-size: 2.5rem; opacity: 0.3; margin-bottom: 12px; }
  .empty-state-card p { font-weight: 600; margin-bottom: 4px; }
  .empty-state-card small { color: var(--color-text-muted); font-size: 0.85rem; }



  /* ===== ITEM BREAKDOWN ===== */
  .item-breakdown-section {
    margin-bottom: 28px;
  }

  .section-desc {
    font-size: 0.82rem;
    color: var(--color-text-secondary);
    margin-bottom: 16px;
    line-height: 1.5;
  }

  .section-desc strong {
    color: var(--color-text-primary);
  }

  .section-badge {
    font-size: 0.72rem;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: var(--radius-full);
    background: var(--color-accent-subtle);
    color: var(--color-accent);
    border: 1px solid rgba(79, 70, 229, 0.12);
  }

  .section-badge-confirmed {
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    border-color: rgba(16, 185, 129, 0.2);
  }

  .section-badge-pending {
    background: rgba(245, 158, 11, 0.1);
    color: #D97706;
    border-color: rgba(245, 158, 11, 0.2);
  }

  .breakdown-group {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: 20px;
    box-shadow: var(--shadow-card);
    margin-bottom: 14px;
  }

  .breakdown-group-paket {
    margin-bottom: 0;
  }

  .breakdown-group-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 14px;
    margin-bottom: 14px;
    border-bottom: 1px solid var(--color-border);
  }

  .breakdown-group-icon {
    font-size: 1.2rem;
  }

  .breakdown-group-title {
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--color-text-primary);
    flex: 1;
  }

  .breakdown-group-total {
    font-size: 0.78rem;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: var(--radius-full);
    background: var(--color-bg-tertiary);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }

  .item-breakdown-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .item-row {
    animation: fadeIn 0.4s ease forwards;
    opacity: 0;
  }

  .item-row-main {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .item-rank {
    font-size: 0.68rem;
    font-weight: 800;
    color: var(--color-text-muted);
    min-width: 24px;
    text-align: center;
    font-family: var(--font-heading);
  }

  .item-name-col {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .item-name {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--color-text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .item-revenue {
    font-size: 0.68rem;
    color: var(--color-text-muted);
  }

  .item-qty-badge {
    display: flex;
    align-items: baseline;
    gap: 3px;
    background: var(--gradient-primary);
    color: white;
    padding: 4px 12px;
    border-radius: var(--radius-full);
    flex-shrink: 0;
    box-shadow: var(--shadow-accent);
  }

  .item-qty-badge strong {
    font-size: 0.88rem;
    font-family: var(--font-heading);
    font-weight: 800;
  }

  .item-qty-badge small {
    font-size: 0.62rem;
    font-weight: 600;
    opacity: 0.8;
  }

  .item-bar-track {
    height: 4px;
    background: var(--color-bg-tertiary);
    border-radius: 4px;
    margin-top: 6px;
    margin-left: 36px;
    overflow: hidden;
  }

  .item-bar-fill {
    height: 100%;
    background: var(--gradient-primary);
    border-radius: 4px;
    transition: width 0.6s ease;
  }

  /* Paket breakdown */
  .paket-breakdown-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
  }

  .paket-item-card {
    padding: 14px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all 0.15s;
  }

  .paket-item-card:hover {
    border-color: var(--color-border-hover);
  }

  .paket-item-name {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: 8px;
  }

  .paket-item-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .paket-item-qty {
    font-size: 0.82rem;
    font-weight: 800;
    color: var(--color-accent);
    font-family: var(--font-heading);
  }

  .paket-item-rev {
    font-size: 0.72rem;
    color: var(--color-text-muted);
    font-weight: 600;
  }

  /* ===== PENDING ORDERS SECTION ===== */
  .pending-section {
    margin-top: 28px;
    animation-delay: 0.3s !important;
  }

  .pending-table td { vertical-align: middle; }

  .wa-number {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--color-text-primary);
    font-family: 'SF Mono', Monaco, monospace;
  }

  .items-mini {
    display: flex;
    flex-direction: column;
    gap: 1px;
    max-width: 220px;
  }
  .items-mini small {
    font-size: 0.73rem;
    color: var(--color-text-muted);
  }

  /* Followup tip banner */
  .followup-tip {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.06), rgba(245, 158, 11, 0.12));
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
    font-size: 0.78rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
  }

  .followup-tip svg {
    flex-shrink: 0;
    color: #D97706;
    margin-top: 1px;
  }

  .followup-tip strong {
    color: #92400E;
  }

  .wa-followup-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    background: #25D366;
    color: white;
    font-size: 0.78rem;
    font-weight: 700;
    font-family: var(--font-body);
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
  }

  .wa-followup-btn:hover:not(:disabled) {
    background: #1DA851;
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
    transform: translateY(-1px);
  }

  .wa-followup-btn:disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }

  .wa-followup-btn.sending {
    background: #6B7280;
    box-shadow: none;
    animation: pulse-btn 1.2s ease-in-out infinite;
  }

  .wa-followup-btn.sent {
    background: #059669;
    box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
  }

  @keyframes pulse-btn {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
  }



  .pending-empty {
    border-left: 4px solid #22C55E;
  }

  /* ===== FOLLOW UP SUCCESS MODAL ===== */
  .followup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(8px);
    z-index: 5000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    padding: 24px;
  }

  .followup-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .followup-modal {
    background: white;
    border-radius: var(--radius-xl);
    padding: 36px 32px 28px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: 0 24px 64px rgba(0,0,0,0.18);
    transform: scale(0.85) translateY(20px);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .followup-overlay.open .followup-modal {
    transform: scale(1) translateY(0);
  }

  /* Animated Checkmark */
  .followup-checkmark-wrap {
    width: 72px;
    height: 72px;
    margin: 0 auto 20px;
  }

  .followup-checkmark {
    width: 72px;
    height: 72px;
    border-radius: 50%;
  }

  .followup-checkmark-circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #25D366;
    fill: none;
  }

  .followup-overlay.open .followup-checkmark-circle {
    animation: checkmark-stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) 0.15s forwards;
  }

  .followup-checkmark-check {
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke: #25D366;
  }

  .followup-overlay.open .followup-checkmark-check {
    animation: checkmark-stroke 0.35s cubic-bezier(0.65, 0, 0.45, 1) 0.55s forwards;
  }

  @keyframes checkmark-stroke {
    100% { stroke-dashoffset: 0; }
  }

  .followup-modal h3 {
    font-size: 1.15rem;
    font-weight: 800;
    color: var(--color-text-primary);
    margin-bottom: 8px;
  }

  .followup-modal p {
    font-size: 0.88rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: 16px;
  }

  .followup-modal p strong {
    color: var(--color-accent);
  }

  .followup-modal-tip {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 10px 14px;
    background: rgba(245, 158, 11, 0.08);
    border: 1px solid rgba(245, 158, 11, 0.15);
    border-radius: var(--radius-md);
    margin-bottom: 20px;
    text-align: left;
  }

  .followup-modal-tip svg {
    flex-shrink: 0;
    color: #D97706;
    margin-top: 1px;
  }

  .followup-modal-tip span {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    line-height: 1.5;
  }

  .followup-modal-close-btn {
    width: 100%;
    padding: 12px;
    background: var(--gradient-primary);
    color: white;
    font-size: 0.88rem;
    font-weight: 700;
    font-family: var(--font-body);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow-accent);
  }

  .followup-modal-close-btn:hover {
    box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
    transform: translateY(-1px);
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 1024px) {
    .stats-grid { grid-template-columns: repeat(3, 1fr); }
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .stat-card {
      padding: 14px;
      gap: 10px;
    }

    .stat-icon { width: 42px; height: 42px; }
    .stat-icon svg { width: 18px; height: 18px; }
    .stat-value { font-size: 1.2rem; }
    .stat-value-sm { font-size: 0.95rem; }
    .stat-label { font-size: 0.7rem; }

    .quick-actions { display: flex; }

    .desktop-table { display: none; }
    .mobile-orders-list { display: block; }

    .section-header-row h2 { font-size: 1rem; }

    .dashboard-section { padding: 16px; border-radius: var(--radius-xl); margin-bottom: 20px; }
    .dashboard-section.iter-breakdown-section,
    .dashboard-section.pending-section,
    .dashboard-section.recent-section {
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .breakdown-group { padding: 16px; }
    .item-bar-track { margin-left: 0; }
    .item-rank { display: none; }
    .paket-breakdown-grid { grid-template-columns: 1fr 1fr; }

    .pending-card-meta code { font-size: 0.68rem; }
    .pending-card-action { gap: 10px; }
  }

  @media (max-width: 380px) {
    .stat-card { flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; }
  }
</style>

<style is:global>
  /* ===== GLOBAL DASHBOARD TOP BAR ===== */
  .dashboard-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    background: white;
    padding: 16px 24px;
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-sm);
  }
  .global-filter-wrap {
    position: relative;
    display: flex;
    align-items: center;
  }
  .filter-icon {
    position: absolute;
    left: 12px;
    color: var(--color-text-muted);
    pointer-events: none;
  }
  .modern-filter-select {
    padding: 10px 16px 10px 38px;
    border-radius: var(--radius-full);
    border: 1px solid var(--color-border-strong);
    background: var(--color-bg-secondary);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-primary);
    cursor: pointer;
    outline: none;
    transition: all 0.2s;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 14px center;
    background-size: 16px;
    padding-right: 40px;
    min-width: 220px;
  }
  .modern-filter-select:focus,
  .modern-filter-select:hover {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    background: white;
  }

  .modern-table-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-card);
    overflow: hidden;
  }
  .mtc-header {
    padding: 24px;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    background: var(--color-bg-secondary);
  }
  .mtc-title-area h2 { margin-bottom: 4px; font-size: 1.15rem; }
  .modern-table { width: 100%; border-collapse: collapse; margin-bottom: 0 !important; }
  .modern-table th {
    background: var(--color-bg-tertiary) !important;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-muted);
    padding: 16px 24px !important;
    font-weight: 700;
    border-bottom: 1px solid var(--color-border) !important;
    text-align: left;
  }
  .modern-table th.text-right { text-align: right; }
  .modern-table td {
    padding: 16px 24px !important;
    vertical-align: middle;
    border-bottom: 1px dashed var(--color-border);
    transition: background 0.2s;
    font-size: 0.9rem;
  }
  .modern-tr { animation: fadeIn 0.4s ease forwards; opacity: 0; }
  .modern-tr:hover td { background: var(--color-bg-secondary); }
  .modern-tr:last-child td { border-bottom: none; }
  .modern-rank { font-family: var(--font-heading); font-weight: 800; color: var(--color-text-muted); font-size: 0.9rem; }
  .qty-highlight { font-family: var(--font-heading); font-weight: 800; font-size: 1.1rem; color: var(--color-text-primary); }
  .modern-empty-tr td { padding: 40px !important; text-align: center; color: var(--color-text-muted); font-weight: 500; }
  .badge-primary { background: var(--color-accent); color: white; }

  /* ===== PAGINATION AREA ===== */
  .pagination-footer {
    padding: 16px 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    background: var(--color-bg-secondary);
    border-top: 1px solid var(--color-border);
  }
  .pagination-footer .page-info {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text-muted);
  }
  .pagination-footer .btn {
    padding: 6px 12px;
    border-radius: var(--radius-md);
  }
  
  .pagination-mobile-only {
    display: none;
    border-top: none;
    background: transparent;
    padding: 10px 0 0 0;
  }

  @media (max-width: 768px) {
    .modern-table-card { border-radius: var(--radius-xl); border-left: none; border-right: none; }
    .mtc-header { flex-direction: column; align-items: flex-start; }
    .modern-table th, .modern-table td { padding: 12px 16px !important; }
    
    .dashboard-top-bar { padding: 16px; }
    .modern-filter-select { width: 100%; min-width: auto; }
    .dt-bar-left { display: none; } /* hide left side info on mobile to make room for filter */
    
    .desktop-table .pagination-footer { display: none !important; }
    .pagination-mobile-only { display: flex !important; }
  }

  /* ===== MOBILE ORDER CARDS (GLOBAL for JS rendering) ===== */
  .mobile-orders-list { display: none; }

  /* ===== MODERN SECTION CARD ===== */
  .modern-section-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-card);
    overflow: hidden;
  }
  .msc-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 24px;
    background: linear-gradient(135deg, var(--color-bg-secondary), rgba(99, 102, 241, 0.03));
    border-bottom: 1px solid var(--color-border);
  }
  .msc-title-wrap { display: flex; align-items: center; gap: 14px; }
  .msc-icon {
    width: 40px; height: 40px; border-radius: var(--radius-lg);
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .msc-title { font-size: 1.05rem; font-weight: 800; color: var(--color-text-primary); margin: 0; }
  .msc-subtitle { font-size: 0.75rem; color: var(--color-text-muted); margin: 2px 0 0; }
  .msc-action-link {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 0.82rem; font-weight: 700; color: var(--color-accent);
    text-decoration: none; padding: 6px 14px;
    border-radius: var(--radius-full); background: var(--color-accent-subtle);
    transition: all 0.2s;
  }
  .msc-action-link:hover { background: var(--color-accent); color: white; box-shadow: var(--shadow-accent); }
  .msc-body { padding: 16px 24px 20px; }

  /* ===== MODERN ORDER CARD (MOC) ===== */
  .moc-card {
    display: flex; border-radius: var(--radius-xl); overflow: hidden;
    background: white; border: 1px solid var(--color-border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 0 1px rgba(0,0,0,0.06);
    margin-bottom: 10px; transition: all 0.2s ease;
  }
  .moc-card:hover {
    border-color: var(--color-accent);
    box-shadow: 0 4px 16px rgba(79, 70, 229, 0.08), 0 0 1px rgba(79, 70, 229, 0.12);
    transform: translateY(-1px);
  }
  .moc-accent-bar { width: 5px; flex-shrink: 0; }
  .moc-card-body { flex: 1; padding: 14px 16px; }
  .moc-row-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
  .moc-customer { display: flex; flex-direction: column; gap: 2px; }
  .moc-customer-name { font-size: 0.92rem; font-weight: 700; color: var(--color-text-primary); }
  .moc-customer-phone { font-size: 0.73rem; color: var(--color-text-muted); font-family: 'SF Mono', Monaco, monospace; }
  .moc-divider { height: 1px; background: linear-gradient(90deg, var(--color-border), transparent); margin-bottom: 10px; }
  .moc-row-bottom { display: flex; justify-content: space-between; align-items: center; }
  .moc-order-meta { display: flex; align-items: center; gap: 8px; }
  .moc-order-code { font-size: 0.7rem !important; padding: 2px 6px !important; background: var(--color-bg-tertiary) !important; border-radius: var(--radius-sm) !important; }
  .moc-office { font-size: 0.65rem !important; }
  .moc-amount-wrap { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
  .moc-amount { font-family: var(--font-heading); font-weight: 800; font-size: 0.92rem; color: var(--color-accent); }
  .moc-date { font-size: 0.68rem; color: var(--color-text-muted); }

  /* ===== PENDING MOBILE CARDS ===== */
  .pending-card {
    display: flex; border-radius: var(--radius-xl); overflow: hidden;
    background: white; border: 1px solid var(--color-border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 0 1px rgba(0,0,0,0.06);
    margin-bottom: 10px; transition: all 0.2s ease;
  }
  .pending-card:hover {
    border-color: #F59E0B;
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.1), 0 0 1px rgba(245, 158, 11, 0.2);
    transform: translateY(-1px);
  }
  .pending-card::before {
    content: ''; width: 5px; flex-shrink: 0;
    background: linear-gradient(180deg, #F59E0B, #D97706);
  }
  .pending-card-body { flex: 1; padding: 14px 16px; }
  .pending-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
  .pending-card-customer { display: flex; flex-direction: column; gap: 2px; }
  .pending-card-customer strong { font-size: 0.92rem; font-weight: 700; }
  .pending-card-customer .text-muted { font-size: 0.73rem; font-family: 'SF Mono', Monaco, monospace; }
  .pending-card-items {
    display: flex; flex-direction: column; gap: 2px;
    background: var(--color-bg-secondary); padding: 8px 10px;
    border-radius: var(--radius-md); margin-bottom: 10px;
  }
  .pending-card-items small { font-size: 0.75rem; color: var(--color-text-secondary); font-weight: 500; }
  .pending-card-footer { display: flex; flex-direction: column; gap: 10px; }
  .pending-card-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .pending-card-action { display: flex; justify-content: space-between; align-items: center; }
  .pending-card-total { font-family: var(--font-heading); font-weight: 800; font-size: 1rem; color: var(--color-accent); }

  .wa-followup-btn-mobile {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px; background: #25D366; color: white;
    font-size: 0.82rem; font-weight: 700; font-family: var(--font-body);
    border-radius: var(--radius-md); border: none; cursor: pointer;
    transition: all 0.2s; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
  }
  .wa-followup-btn-mobile:disabled { cursor: not-allowed; opacity: 0.7; }
  .wa-followup-btn-mobile.sending { background: #6B7280; box-shadow: none; animation: pulse-btn 1.2s ease-in-out infinite; }
  .wa-followup-btn-mobile.sent { background: #059669; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3); }
  .wa-followup-btn-mobile:hover:not(:disabled) { background: #1DA851; }

  @media (max-width: 768px) {
    .mobile-orders-list { display: block; }
    .msc-header { flex-direction: column; align-items: flex-start; gap: 12px; padding: 16px; }
    .msc-icon { width: 34px; height: 34px; }
    .msc-title { font-size: 0.95rem; }
  }
</style>
